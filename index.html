<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜éŸ³è³ª å‹•ç”»MP3å¤‰æ›æ©Ÿ v2</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; text-align: center; background-color: #f9f9f9; }
        .container { background: white; border: 1px solid #ddd; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input[type="file"], input[type="text"] { margin: 1rem 0; width: 80%; padding: 10px; }
        button { padding: 12px 24px; font-size: 1rem; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.secondary { background: #6c757d; }
        #message { margin-top: 1rem; color: #333; font-weight: bold; white-space: pre-line; }
        #download-area { margin-top: 1rem; }
        a.download-btn { display: inline-block; padding: 12px 30px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .divider { border-bottom: 2px solid #eee; margin: 20px 0; }
        .badge { background: #ffc107; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

    <h1>å‹•ç”» <span style="font-size:0.8em">â¡</span> MP3 <span class="badge">é«˜éŸ³è³ª320kbps</span></h1>

    <div class="container">
        <h3>ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h3>
        <input type="file" id="uploader" accept="video/*">
        <br>
        <button id="convert-file-btn" disabled>å¤‰æ›é–‹å§‹</button>

        <div class="divider"></div>

        <h3>ğŸ”— URLã‹ã‚‰å–å¾— (ä¸Šç´šè€…å‘ã‘)</h3>
        <p style="font-size:0.8rem; color:red;">â€»YouTubeç­‰ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£(CORS)ã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™</p>
        <input type="text" id="url-input" placeholder="å‹•ç”»ã®ç›´æ¥ãƒªãƒ³ã‚¯(https://.../video.mp4)">
        <br>
        <button id="convert-url-btn" class="secondary" disabled>URLã‹ã‚‰èª­ã¿è¾¼ã‚“ã§å¤‰æ›</button>

        <div id="message"></div>
        <div id="download-area"></div>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        
        const uploader = document.getElementById('uploader');
        const urlInput = document.getElementById('url-input');
        const fileBtn = document.getElementById('convert-file-btn');
        const urlBtn = document.getElementById('convert-url-btn');
        const message = document.getElementById('message');
        const downloadArea = document.getElementById('download-area');

        // åˆæœŸåŒ–
        const loadFFmpeg = async () => {
            message.innerText = 'ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...';
            await ffmpeg.load();
            message.innerText = 'æº–å‚™å®Œäº†ï¼';
            fileBtn.disabled = false;
            urlBtn.disabled = false;
        };
        loadFFmpeg();

        // å…±é€šå¤‰æ›å‡¦ç†é–¢æ•°
        const startConversion = async (inputData, filename) => {
            message.innerText = 'å¤‰æ›ä¸­... (é«˜éŸ³è³ªå‡¦ç†ä¸­)';
            fileBtn.disabled = true;
            urlBtn.disabled = true;
            downloadArea.innerHTML = '';

            try {
                const inputName = 'input_video';
                const outputName = 'output.mp3';

                // ãƒ‡ãƒ¼ã‚¿ã‚’ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«æ›¸ãè¾¼ã¿
                ffmpeg.FS('writeFile', inputName, await fetchFile(inputData));

                // FFmpegã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
                // -i: å…¥åŠ›
                // -vn: æ˜ åƒã‚’ç„¡åŠ¹åŒ–(Video None)
                // -acodec libmp3lame: MP3ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€
                // -b:a 320k: ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ320kbps (é«˜éŸ³è³ª)
                await ffmpeg.run('-i', inputName, '-vn', '-acodec', 'libmp3lame', '-b:a', '320k', outputName);

                // å‡ºåŠ›èª­ã¿è¾¼ã¿
                const data = ffmpeg.FS('readFile', outputName);

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ç”Ÿæˆ
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'audio/mp3' }));
                const link = document.createElement('a');
                link.href = url;
                link.download = filename + '_320k.mp3';
                link.className = 'download-btn';
                link.innerText = 'MP3ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (320kbps)';
                downloadArea.appendChild(link);

                message.innerText = 'å¤‰æ›å®Œäº†ï¼';
            } catch (e) {
                console.error(e);
                message.innerText = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n' + e.message;
            } finally {
                fileBtn.disabled = false;
                urlBtn.disabled = false;
            }
        };

        // ãƒœã‚¿ãƒ³1: ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰
        fileBtn.addEventListener('click', () => {
            const file = uploader.files[0];
            if (!file) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„');
            startConversion(file, file.name.split('.')[0]);
        });

        // ãƒœã‚¿ãƒ³2: URLã‹ã‚‰
        urlBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            if (!url) return alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            
            message.innerText = 'URLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';
            try {
                // Fetchã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const res = await fetch(url);
                if (!res.ok) throw new Error(`ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ (Status: ${res.status})`);
                const blob = await res.blob();
                
                // å¤‰æ›é–‹å§‹
                startConversion(blob, "url_video");
            } catch (e) {
                console.error(e);
                message.innerText = 'ã€ã‚¨ãƒ©ãƒ¼ã€‘URLã‹ã‚‰å‹•ç”»ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nYouTubeãªã©ã¯CORSåˆ¶é™ã«ã‚ˆã‚Šç›´æ¥å–å¾—ã§ãã¾ã›ã‚“ã€‚\n' + e.message;
            }
        });
    </script>
</body>
</html>
